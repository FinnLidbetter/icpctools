<html>
<head>
  <title>Presentation Admin</title>
  <link rel="stylesheet" href="/cds.css"/>
  <link rel="icon" type="image/png" href="/favicon.png"/>
</head>
<body>

<script>
var last;
function setPresentation(id) {
   //document.getElementById("team"+id).disabled = true;

   var xmlhttp = new XMLHttpRequest();

   xmlhttp.onreadystatechange = function() {
     document.getElementById("status").innerHTML = "Changing to " + id;
     if (xmlhttp.readyState == 4) {
        if (xmlhttp.status == 200) {
           document.getElementById("status").innerHTML = "Success";
        } else
           document.getElementById("status").innerHTML = xmlhttp.responseText;
        //document.getElementById("team"+id).disabled = false;
     }
   };
   
   xmlhttp.open("PUT", "present/" + id, true);
   xmlhttp.send();
}
</script>

<h1>Presentation Admin</h1>

<p>Simple web admin, allows you to apply one presentation to all clients.</p>

<h3>Summary</h3>

<table id="client-summary-table">
<tr>
<th>Id</th><th>Display</th>
</tr>
</table>

<h2>Presentations</h2>

<table id="pres-table">
<tr>
<th align=left>Category</th>
<th align=left>Presentation</th>
<th align=left>Description</th>
<th align=left>Action</th>
</tr>
</table>

<div id="status"></div>

<h2>Clients (<span id="client-count">0</span>)</h2>

<table id="client-table">
<tr>
<th>Id</th><th>Display</th><th>Presentation</th><th width="75px"></th>
<th>Id</th><th>Display</th><th>Presentation</th><th width="75px"></th>
<th>Id</th><th>Display</th><th>Presentation</th>
</tr>
</table>

<script src="/js/jquery-3.3.1.min.js"></script>
<script src="/js/ui.js"></script>
<script type="text/javascript">

$(document).ready(function() {

var pres;
var clients;

function fillPresTable() {
  if (pres == null)
    return;
  
  // sort
  pres.sort(function(a, b) {
	c = a.category.localeCompare(b.category);
	if (c != 0)
		return c;
	return a.name.localeCompare(b.name);
  });

  var lastCategory;
  for (var i = 0; i < pres.length; i++) {
	  var col = '<td>';
	if (pres[i].category != lastCategory) {
	  col += '<b>' + pres[i].category + '</b>';
	  lastCategory = pres[i].category;
	}
	col += '</td><td id=' + pres[i].id + '>' + pres[i].name + '</td><td>';
	if (pres[i].description != null)
		col += pres[i].description;
	col += '</td><td><a href="javascript:setPresentation(\'' + pres[i].classname + '\')">Apply to all</a></td>';
    var row = $('<tr></tr>');
    row.append($(col));
    $('#pres-table').append(row);
  }
}

function fillClientsTable() {
  if (clients == null)
    return;
  
  $('#client-count').text(clients.length);

  // sort
  clients.sort(function(a, b) {
	return a.id.localeCompare(b.id);
  });

  var map = new Map();
  var count = 0;
  var col = '';
  $('#client-table').find("tr:gt(0)").remove();
  for (var i = 0; i < clients.length; i++) {
	col += '<td id=' + clients[i].id + '>' + clients[i].id + '</td>';
	if (clients[i].display != null)
		col += '<td>' + clients[i].display + '</td>';
	else
		col += '<td></td>';
	if (clients[i].presentation != null) {
		col += '<td>' + clients[i].presentation + '</td>';
		var key = clients[i].presentation;
		if (map.has(key)) {
			var v = map.get(key);
			map.set(key, v+1);
		} else
			map.set(key, 1);
	} else
		col += '<td></td>';

	count++;
	if (count % 3 == 0 || count == clients.length) {
		var row = $('<tr></tr>');
	    row.append($(col));
	    $('#client-table').append(row);
		col = '';
	} else {
	   col += '<td></td>';
	}
  }

  count = 0;
  $('#client-summary-table').find("tr:gt(0)").remove();
  for (var [key, value] of map) {
	  var col = '<td>' + key + '</td><td>' + value + "</td>";
	  row = $('<tr></tr>');
	  row.append($(col));
	  $('#client-summary-table').append(row);
	  count += value;
  }
  col = '<td align=right><b>Total</b></td><td>' + count + "</td>";
  row = $('<tr></tr>');
  row.append($(col));
  $('#client-summary-table').append(row);
}

var loadPres=$.ajax({
	  url: "/presentation/admin/present",
	  success: function(result) {
	    pres = result;
	  }
	})

function loadClients2() {
	$.ajax({
	  url: "/presentation/admin/clients",
	  success: function(result) {
	    clients = result;
	  }
	})
}

$.when(loadPres).done(function() { fillPresTable() }).fail(function(result) {
    alert("Could not load page! " + result);
  })

function repeatIt() {
	console.log("repeat!");
	loadClients2();
	fillClientsTable();
	setTimeout(arguments.callee, 2500);
}

repeatIt();

$.when(loadClients2()).done(function() { fillClientsTable() }).fail(function(result) {
    alert("Could not load page! " + result);
  })
})

</script>

</body>
</html>